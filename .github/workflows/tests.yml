name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, bcmath, pdo, mysql, zip
          coverage: xdebug

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Check code style with Laravel Pint
        run: composer check-cs

      - name: Run PHPStan static analysis
        run: composer check-stan

  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    
    services:
      mysql_main:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: main_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      mysql_technical:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: technical_issues_db
        ports:
          - 3307:3306
        options: >-
          --health-cmd="mysqladmin ping -ppassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      mysql_billing:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: account_billing_db
        ports:
          - 3308:3306
        options: >-
          --health-cmd="mysqladmin ping -ppassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      mysql_product:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: product_service_db
        ports:
          - 3309:3306
        options: >-
          --health-cmd="mysqladmin ping -ppassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      mysql_inquiry:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: general_inquiry_db
        ports:
          - 3310:3306
        options: >-
          --health-cmd="mysqladmin ping -ppassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      mysql_feedback:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: feedback_suggestions_db
        ports:
          - 3311:3306
        options: >-
          --health-cmd="mysqladmin ping -ppassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, bcmath, pdo, mysql, zip
          coverage: xdebug

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Copy environment file
        run: cp .env.example .env

      - name: Generate application key
        run: php artisan key:generate

      - name: Configure database connections for CI
        run: |
          # Main database
          php artisan config:clear
          echo "DB_CONNECTION=mysql" >> .env
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_PORT=3306" >> .env
          echo "DB_DATABASE=main_db" >> .env
          echo "DB_USERNAME=root" >> .env
          echo "DB_PASSWORD=password" >> .env
          
          # Technical Issues DB
          echo "DB_TECHNICAL_HOST=127.0.0.1" >> .env
          echo "DB_TECHNICAL_PORT=3307" >> .env
          echo "DB_TECHNICAL_DATABASE=technical_issues_db" >> .env
          
          # Billing DB
          echo "DB_BILLING_HOST=127.0.0.1" >> .env
          echo "DB_BILLING_PORT=3308" >> .env
          echo "DB_BILLING_DATABASE=account_billing_db" >> .env
          
          # Product DB
          echo "DB_PRODUCT_HOST=127.0.0.1" >> .env
          echo "DB_PRODUCT_PORT=3309" >> .env
          echo "DB_PRODUCT_DATABASE=product_service_db" >> .env
          
          # Inquiry DB
          echo "DB_INQUIRY_HOST=127.0.0.1" >> .env
          echo "DB_INQUIRY_PORT=3310" >> .env
          echo "DB_INQUIRY_DATABASE=general_inquiry_db" >> .env
          
          # Feedback DB
          echo "DB_FEEDBACK_HOST=127.0.0.1" >> .env
          echo "DB_FEEDBACK_PORT=3311" >> .env
          echo "DB_FEEDBACK_DATABASE=feedback_suggestions_db" >> .env
          
          # Redis
          echo "REDIS_HOST=127.0.0.1" >> .env
          echo "CACHE_STORE=redis" >> .env

          # App settings
          echo "APP_ENV=testing" >> .env
          echo "APP_DEBUG=true" >> .env

      - name: Wait for MySQL services to be ready
        run: |
          echo "Waiting for MySQL services to be ready..."
          for port in 3306 3307 3308 3309 3310 3311; do
            echo "Checking MySQL on port $port..."
            for i in {1..30}; do
              if mysqladmin ping -h"127.0.0.1" -P"$port" -u"root" -p"password" --silent 2>/dev/null; then
                echo "âœ“ MySQL on port $port is ready"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âœ— MySQL on port $port failed to start"
                exit 1
              fi
              sleep 2
            done
          done
          echo "All MySQL services are ready!"

      - name: Run tests with coverage
        run: composer run-tests

  deployment-check:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    needs: [code-quality, tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: All checks passed
        run: |
          echo "âœ… All quality checks passed!"
          echo "âœ… All tests passed!"
          echo "âœ… Security audit passed!"
          echo "ğŸš€ Ready for deployment!"

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [code-quality, tests]
    if: always()
    
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.code-quality.result }}" == "failure" ]; then
            echo "âŒ Code quality checks failed"
            exit 1
          fi
          if [ "${{ needs.tests.result }}" == "failure" ]; then
            echo "âŒ Tests failed"
            exit 1
          fi
          if [ "${{ needs.security-check.result }}" == "failure" ]; then
            echo "âŒ Security audit failed"
            exit 1
          fi
          echo "âœ… All checks passed successfully!"